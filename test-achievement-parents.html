<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achievements Parentsè¡¨åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        h1 { text-align: center; margin-bottom: 30px; }
        h2 { margin-top: 30px; margin-bottom: 15px; }
        h3 { margin-top: 20px; margin-bottom: 10px; }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .collaborator-item {
            background: #e3f2fd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ Achievements Parents ä¸­é—´è¡¨åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="container">
        <h2>ğŸ“Š æ•°æ®åº“ç»Ÿè®¡</h2>
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalAchievements">-</div>
                <div class="stat-label">æ€»æˆæœæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRelations">-</div>
                <div class="stat-label">åä½œå…³ç³»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCollaborators">-</div>
                <div class="stat-label">å‚ä¸åä½œç”¨æˆ·æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgCollaborators">-</div>
                <div class="stat-label">å¹³å‡åä½œè€…æ•°</div>
            </div>
        </div>
        <button onclick="loadStats()">ğŸ”„ åˆ·æ–°ç»Ÿè®¡</button>
    </div>

    <div class="two-column">
        <div class="container">
            <h2>â• æ·»åŠ åä½œè€…å…³ç³»</h2>
            <div class="section">
                <h3>æˆæœID:</h3>
                <input type="text" id="achievementId" placeholder="è¾“å…¥æˆæœUUID">
                
                <h3>åä½œè€…IDåˆ—è¡¨:</h3>
                <textarea id="parentIds" rows="3" placeholder="è¾“å…¥åä½œè€…UUIDï¼Œä¸€è¡Œä¸€ä¸ª"></textarea>
                
                <h3>æˆ–ä»ç°æœ‰ç”¨æˆ·é€‰æ‹©:</h3>
                <select id="userSelect" multiple size="4">
                    <option value="">-- é€‰æ‹©ç”¨æˆ· --</option>
                </select>
                
                <button onclick="addCollaborators()">ğŸ‘¥ æ·»åŠ åä½œè€…</button>
                <button onclick="loadUsers()">ğŸ”„ åŠ è½½ç”¨æˆ·åˆ—è¡¨</button>
                
                <div id="addResult" class="result"></div>
            </div>
        </div>

        <div class="container">
            <h2>ğŸ” æŸ¥è¯¢åä½œè€…å…³ç³»</h2>
            <div class="section">
                <h3>æŒ‰æˆæœIDæŸ¥è¯¢:</h3>
                <input type="text" id="queryAchievementId" placeholder="è¾“å…¥æˆæœUUID">
                
                <h3>æˆ–æŒ‰åä½œè€…IDæŸ¥è¯¢:</h3>
                <input type="text" id="queryParentId" placeholder="è¾“å…¥ç”¨æˆ·UUID">
                
                <button onclick="queryCollaborators()">ğŸ” æŸ¥è¯¢</button>
                <button onclick="queryByCollaborator()">ğŸ‘¤ æŸ¥è¯¢åä½œè€…å‚ä¸çš„æˆæœ</button>
                
                <div id="queryResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ—‘ï¸ åˆ é™¤åä½œè€…å…³ç³»</h2>
        <div class="section">
            <h3>åˆ é™¤ç‰¹å®šæˆæœçš„æ‰€æœ‰åä½œè€…:</h3>
            <input type="text" id="deleteAchievementId" placeholder="è¾“å…¥æˆæœUUID">
            
            <button onclick="deleteCollaborators()">ğŸ—‘ï¸ åˆ é™¤</button>
            
            <div id="deleteResult" class="result"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æ‰€æœ‰åä½œè€…å…³ç³»</h2>
        <button onclick="loadAllRelations()">ğŸ“‹ åŠ è½½æ‰€æœ‰å…³ç³»</button>
        <div id="allRelations" class="result"></div>
    </div>

    <script>
        // Supabase é…ç½® - è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…é…ç½®
        const supabaseUrl = 'https://your-project.supabase.co';
        const supabaseKey = 'your-anon-key';
        
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('id, username, full_name, email')
                    .eq('role', 1) // åªåŠ è½½å­¦ç”Ÿ
                    .order('username');

                if (error) {
                    showResult('userSelect', 'åŠ è½½ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">-- é€‰æ‹©ç”¨æˆ· --</option>';
                
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.full_name || user.username} (${user.email})`;
                    select.appendChild(option);
                });

                showResult('userSelect', `å·²åŠ è½½ ${data.length} ä¸ªç”¨æˆ·`, 'success');
            } catch (err) {
                showResult('userSelect', 'åŠ è½½ç”¨æˆ·å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        // æ·»åŠ åä½œè€…
        async function addCollaborators() {
            const achievementId = document.getElementById('achievementId').value.trim();
            const parentIdsText = document.getElementById('parentIds').value.trim();
            const userSelect = document.getElementById('userSelect');
            const selectedOptions = Array.from(userSelect.selectedOptions);

            if (!achievementId) {
                showResult('addResult', 'è¯·è¾“å…¥æˆæœID', 'error');
                return;
            }

            // åˆå¹¶æ‰€æœ‰åä½œè€…ID
            let parentIds = [];
            if (parentIdsText) {
                parentIds = parentIdsText.split('\\n').map(id => id.trim()).filter(id => id);
            }
            if (selectedOptions.length > 0) {
                const selectedIds = selectedOptions.map(option => option.value);
                parentIds = [...new Set([...parentIds, ...selectedIds])]; // å»é‡
            }

            if (parentIds.length === 0) {
                showResult('addResult', 'è¯·è¾“å…¥åä½œè€…ID', 'error');
                return;
            }

            try {
                const insertData = parentIds.map(parentId => ({
                    achievement_id: achievementId,
                    parent_id: parentId
                }));

                const { data, error } = await supabase
                    .from('achievements_parents')
                    .insert(insertData)
                    .select('*');

                if (error) {
                    showResult('addResult', 'æ·»åŠ å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                showResult('addResult', `æˆåŠŸæ·»åŠ  ${data.length} ä¸ªåä½œè€…å…³ç³»\\n\\n` + 
                    JSON.stringify(data, null, 2), 'success');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('achievementId').value = '';
                document.getElementById('parentIds').value = '';
                userSelect.selectedIndex = 0;
                
                // åˆ·æ–°ç»Ÿè®¡
                loadStats();
            } catch (err) {
                showResult('addResult', 'æ·»åŠ å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        // æŸ¥è¯¢åä½œè€…
        async function queryCollaborators() {
            const achievementId = document.getElementById('queryAchievementId').value.trim();

            if (!achievementId) {
                showResult('queryResult', 'è¯·è¾“å…¥æˆæœID', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('achievements_parents')
                    .select(`
                        *,
                        parent:users!parent_id (id, username, full_name, email)
                    `)
                    .eq('achievement_id', achievementId);

                if (error) {
                    showResult('queryResult', 'æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                if (data.length === 0) {
                    showResult('queryResult', 'è¯¥æˆæœæ²¡æœ‰åä½œè€…', 'success');
                    return;
                }

                const result = `æ‰¾åˆ° ${data.length} ä¸ªåä½œè€…:\\n\\n` + 
                    data.map(item => `- ${item.parent.full_name || item.parent.username} (${item.parent.email})`).join('\\n') +
                    '\\n\\nè¯¦ç»†ä¿¡æ¯:\\n' + JSON.stringify(data, null, 2);

                showResult('queryResult', result, 'success');
            } catch (err) {
                showResult('queryResult', 'æŸ¥è¯¢å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        // æŸ¥è¯¢åä½œè€…å‚ä¸çš„æˆæœ
        async function queryByCollaborator() {
            const parentId = document.getElementById('queryParentId').value.trim();

            if (!parentId) {
                showResult('queryResult', 'è¯·è¾“å…¥åä½œè€…ID', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('achievements_parents')
                    .select(`
                        *,
                        achievement:achievements!achievement_id (id, title, created_at)
                    `)
                    .eq('parent_id', parentId);

                if (error) {
                    showResult('queryResult', 'æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                if (data.length === 0) {
                    showResult('queryResult', 'è¯¥ç”¨æˆ·æ²¡æœ‰å‚ä¸ä»»ä½•æˆæœ', 'success');
                    return;
                }

                const result = `è¯¥ç”¨æˆ·å‚ä¸äº† ${data.length} ä¸ªæˆæœ:\\n\\n` + 
                    data.map(item => `- ${item.achievement.title} (åˆ›å»ºäº: ${new Date(item.achievement.created_at).toLocaleDateString()})`).join('\\n') +
                    '\\n\\nè¯¦ç»†ä¿¡æ¯:\\n' + JSON.stringify(data, null, 2);

                showResult('queryResult', result, 'success');
            } catch (err) {
                showResult('queryResult', 'æŸ¥è¯¢å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        // åˆ é™¤åä½œè€…
        async function deleteCollaborators() {
            const achievementId = document.getElementById('deleteAchievementId').value.trim();

            if (!achievementId) {
                showResult('deleteResult', 'è¯·è¾“å…¥æˆæœID', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æˆæœçš„æ‰€æœ‰åä½œè€…å…³ç³»å—ï¼Ÿ')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('achievements_parents')
                    .delete()
                    .eq('achievement_id', achievementId);

                if (error) {
                    showResult('deleteResult', 'åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                showResult('deleteResult', 'å·²åˆ é™¤è¯¥æˆæœçš„æ‰€æœ‰åä½œè€…å…³ç³»', 'success');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('deleteAchievementId').value = '';
                
                // åˆ·æ–°ç»Ÿè®¡
                loadStats();
            } catch (err) {
                showResult('deleteResult', 'åˆ é™¤å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰å…³ç³»
        async function loadAllRelations() {
            try {
                const { data, error } = await supabase
                    .from('achievements_parents')
                    .select(`
                        *,
                        achievement:achievements!achievement_id (title),
                        parent:users!parent_id (username, full_name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) {
                    showResult('allRelations', 'åŠ è½½å¤±è´¥: ' + error.message, 'error');
                    return;
                }

                const result = `æœ€è¿‘50ä¸ªåä½œå…³ç³»:\\n\\n` + 
                    data.map(item => `${item.achievement.title} â† ${item.parent.full_name || item.parent.username}`).join('\\n');

                showResult('allRelations', result, 'success');
            } catch (err) {
                showResult('allRelations', 'åŠ è½½å¼‚å¸¸: ' + err.message, 'error');
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                // è·å–æ€»æˆæœæ•°
                const { count: achievementCount } = await supabase
                    .from('achievements')
                    .select('*', { count: 'exact', head: true });

                // è·å–æ€»å…³ç³»æ•°
                const { count: relationCount } = await supabase
                    .from('achievements_parents')
                    .select('*', { count: 'exact', head: true });

                // è·å–ä¸åŒåä½œç”¨æˆ·æ•°
                const { data: uniqueCollaborators } = await supabase
                    .from('achievements_parents')
                    .select('parent_id')
                    .not('parent_id', 'is', null);

                const uniqueCollaboratorIds = [...new Set(uniqueCollaborators.map(item => item.parent_id))];

                // è®¡ç®—å¹³å‡åä½œè€…æ•°
                const avgCollaborators = achievementCount > 0 ? (relationCount / achievementCount).toFixed(1) : 0;

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('totalAchievements').textContent = achievementCount || 0;
                document.getElementById('totalRelations').textContent = relationCount || 0;
                document.getElementById('totalCollaborators').textContent = uniqueCollaboratorIds.length;
                document.getElementById('avgCollaborators').textContent = avgCollaborators;

            } catch (err) {
                console.error('ç»Ÿè®¡åŠ è½½å¤±è´¥:', err);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadStats();
            loadUsers();
        };
    </script>
</body>
</html>