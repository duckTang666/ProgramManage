<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¡æ‰¹é¡µé¢å¤šåä½œè€…æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
        .achievement-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 10px 0; 
            background: #f9f9f9; 
        }
        .collaborator-tag { 
            display: inline-block; 
            background: #e3f2fd; 
            border: 1px solid #90caf9; 
            border-radius: 16px; 
            padding: 4px 12px; 
            margin: 2px; 
            font-size: 14px; 
        }
        .collaborator-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #1976d2;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>æ•™å¸ˆç«¯æˆæœå®¡æ‰¹é¡µé¢ - å¤šåä½œè€…æ˜¾ç¤ºæµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>åŠŸèƒ½è¯´æ˜</h3>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•æ•™å¸ˆç«¯æˆæœå®¡æ‰¹é¡µé¢çš„å¤šåä½œè€…æ˜¾ç¤ºåŠŸèƒ½ã€‚</p>
        <p><strong>å®ç°åŠŸèƒ½ï¼š</strong></p>
        <ul>
            <li>âœ… ä¿®æ”¹ <code>getAchievementsForInstructor</code> æ–¹æ³•ï¼ŒåŒ…å«åä½œè€…ä¿¡æ¯</li>
            <li>âœ… åœ¨æˆæœåˆ—è¡¨ä¸­æ·»åŠ "åä½œè€…"åˆ—</li>
            <li>âœ… åœ¨æˆæœé¢„è§ˆæ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºå¤šä¸ªåä½œè€…</li>
            <li>âœ… åä½œè€…ä¿¡æ¯ä» <code>achievements_parents</code> è¡¨è·å–</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•å‚æ•°</h3>
        <label for="instructorId">æ•™å¸ˆID (instructor_id):</label><br>
        <input type="text" id="instructorId" placeholder="è¾“å…¥æ•™å¸ˆUUID" size="40" value="">
        <br><br>
        
        <button onclick="testGetAchievements()">ğŸ” æµ‹è¯•è·å–æˆæœåˆ—è¡¨</button>
        <button onclick="testGetAchievementWithParents()">ğŸ‘¥ æµ‹è¯•è·å–å•ä¸ªæˆæœ+åä½œè€…</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
    </div>

    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://vntvrdkjtfdcnvwgrubo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZudHZyZGtqdGZkY252d2dydWJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MTI5MjcsImV4cCI6MjA1MTM4ODkyN30.5xflIIFviYqA8Fh_T3mB_2qTm0_Hp3s2_BhZqW7zJ8g';

        // ç®€åŒ–çš„Supabaseå®¢æˆ·ç«¯
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
            }

            from(table) {
                return new TableBuilder(this, table);
            }

            async request(method, url, options = {}) {
                const response = await fetch(`${this.url}/rest/v1${url}`, {
                    method,
                    headers: {
                        'apikey': this.key,
                        'Authorization': `Bearer ${this.key}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`HTTP ${response.status}: ${error.message || response.statusText}`);
                }

                const data = await response.json();
                return { data, error: null };
            }
        }

        class TableBuilder {
            constructor(client, table) {
                this.client = client;
                this.table = table;
                this.query = {
                    select: '*',
                    filter: [],
                    orderBy: null
                };
            }

            select(columns = '*') {
                this.query.select = columns;
                return this;
            }

            eq(column, value) {
                this.query.filter.push(`${column}=eq.${value}`);
                return this;
            }

            order(column, options = {}) {
                const direction = options.ascending ? 'asc' : 'desc';
                this.query.orderBy = `${column}.${direction}`;
                return this;
            }

            async get() {
                let url = `/${this.table}?select=${this.query.select}`;
                
                if (this.query.filter.length > 0) {
                    url += '&' + this.query.filter.join('&');
                }
                
                if (this.query.orderBy) {
                    url += `&order=${this.query.orderBy}`;
                }

                return this.client.request('GET', url);
            }

            async single() {
                const result = await this.get();
                return {
                    data: result.data?.[0] || null,
                    error: result.error
                };
            }
        }

        const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function renderAchievement(achievement) {
            const collaboratorHtml = achievement.parents && achievement.parents.length > 0 
                ? achievement.parents.map(parent => `
                    <span class="collaborator-tag">
                        <span class="collaborator-avatar">${(parent.full_name || parent.username || 'æœªçŸ¥').charAt(0).toUpperCase()}</span>
                        ${parent.full_name || parent.username}
                        ${parent.email ? `(${parent.email})` : ''}
                    </span>
                `).join('')
                : '<span class="warning">æ— åä½œè€…</span>';

            return `
                <div class="achievement-card">
                    <h4>ğŸ“ ${achievement.title}</h4>
                    <p><strong>ç±»å‹:</strong> ${achievement.achievement_type?.name || 'æœªçŸ¥'}</p>
                    <p><strong>å‘å¸ƒå­¦ç”Ÿ:</strong> ${achievement.publisher?.full_name || achievement.publisher?.username || 'æœªçŸ¥'} (${achievement.publisher?.email || 'æ— é‚®ç®±'})</p>
                    <p><strong>æŒ‡å¯¼è€å¸ˆ:</strong> ${achievement.instructor?.full_name || achievement.instructor?.username || 'æœªçŸ¥'}</p>
                    <p><strong>åä½œè€…:</strong></p>
                    <div>${collaboratorHtml}</div>
                    <p><strong>çŠ¶æ€:</strong> ${getStatusText(achievement.status)}</p>
                    <p><strong>åˆ†æ•°:</strong> ${achievement.score !== null ? achievement.score + 'åˆ†' : 'æœªè¯„åˆ†'}</p>
                    <p><strong>æäº¤æ—¶é—´:</strong> ${new Date(achievement.created_at).toLocaleString('zh-CN')}</p>
                </div>
            `;
        }

        function getStatusText(status) {
            switch (status) {
                case 0: return 'è‰ç¨¿';
                case 1: return 'å¾…å®¡æ ¸';
                case 2: return 'å·²é€šè¿‡';
                case 3: return 'å·²æ‹’ç»';
                default: return 'æœªçŸ¥çŠ¶æ€';
            }
        }

        async function testGetAchievements() {
            try {
                log('ğŸ” å¼€å§‹æµ‹è¯•è·å–æˆæœåˆ—è¡¨ï¼ˆåŒ…å«åä½œè€…ä¿¡æ¯ï¼‰...', 'info');

                const instructorId = document.getElementById('instructorId').value.trim();

                if (!instructorId) {
                    log('âŒ è¯·è¾“å…¥æ•™å¸ˆID', 'error');
                    return;
                }

                log(`ğŸ‘¨â€ğŸ« æ•™å¸ˆID: ${instructorId}`, 'info');

                // æ­¥éª¤1ï¼šè·å–æ•™å¸ˆçš„åŸºæœ¬æˆæœåˆ—è¡¨
                const { data: achievements, error: basicError } = await supabase
                    .from('achievements')
                    .select(`
                        *,
                        publisher:users!publisher_id (
                            id,
                            username,
                            email,
                            full_name,
                            class_id
                        ),
                        instructor:users!instructor_id (
                            id,
                            username,
                            email,
                            full_name
                        ),
                        achievement_type:achievement_types (
                            id,
                            name
                        )
                    `)
                    .eq('instructor_id', instructorId)
                    .order('created_at', { ascending: false });

                if (basicError) {
                    log(`âŒ åŸºç¡€æˆæœæŸ¥è¯¢å¤±è´¥: ${basicError.message}`, 'error');
                    return;
                }

                if (!achievements || achievements.length === 0) {
                    log('ğŸ“‹ è¯¥æ•™å¸ˆæ²¡æœ‰ç›¸å…³æˆæœ', 'info');
                    return;
                }

                log(`ğŸ“Š æ‰¾åˆ° ${achievements.length} ä¸ªåŸºç¡€æˆæœ`, 'info');

                // æ­¥éª¤2ï¼šä¸ºæ¯ä¸ªæˆæœè·å–åä½œè€…ä¿¡æ¯
                const achievementsWithParents = await Promise.all(
                    achievements.map(async (achievement) => {
                        // ä»achievements_parentsè¡¨è·å–åä½œè€…ä¿¡æ¯
                        const { data: parentRelations, error: parentError } = await supabase
                            .from('achievements_parents')
                            .select(`
                                *,
                                parent:users!parent_id (id, username, email, full_name)
                            `)
                            .eq('achievement_id', achievement.id)
                            .order('id');

                        if (parentError) {
                            log(`âš ï¸ è·å–æˆæœ ${achievement.id} çš„åä½œè€…å¤±è´¥: ${parentError.message}`, 'warning');
                            achievement.parents = [];
                        } else {
                            const parents = parentRelations?.map(item => item.parent).filter(Boolean) || [];
                            achievement.parents = parents;
                            log(`ğŸ‘¥ æˆæœ "${achievement.title}" æœ‰ ${parents.length} ä¸ªåä½œè€…`, 'info');
                        }

                        return achievement;
                    })
                );

                // æ˜¾ç¤ºç»“æœ
                log('âœ… æˆæœåˆ—è¡¨è·å–æˆåŠŸï¼Œå¼€å§‹æ¸²æŸ“...', 'success');

                const resultsDiv = document.getElementById('results');
                const renderDiv = document.createElement('div');
                renderDiv.innerHTML = `
                    <h3>ğŸ“‹ æˆæœåˆ—è¡¨ï¼ˆå«åä½œè€…ä¿¡æ¯ï¼‰</h3>
                    ${achievementsWithParents.map(renderAchievement).join('')}
                `;
                resultsDiv.appendChild(renderDiv);

                log(`ğŸ‰ æˆåŠŸæ¸²æŸ“ ${achievementsWithParents.length} ä¸ªæˆæœçš„åä½œè€…ä¿¡æ¯ï¼`, 'success');

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testGetAchievementWithParents() {
            try {
                log('ğŸ” å¼€å§‹æµ‹è¯•å•ä¸ªæˆæœ+åä½œè€…æŸ¥è¯¢...', 'info');

                const instructorId = document.getElementById('instructorId').value.trim();

                if (!instructorId) {
                    log('âŒ è¯·è¾“å…¥æ•™å¸ˆID', 'error');
                    return;
                }

                // é¦–å…ˆè·å–ä¸€ä¸ªæˆæœID
                const { data: achievements, error: listError } = await supabase
                    .from('achievements')
                    .select('id, title')
                    .eq('instructor_id', instructorId)
                    .limit(1);

                if (listError || !achievements || achievements.length === 0) {
                    log('âŒ æœªæ‰¾åˆ°ç›¸å…³æˆæœ', 'error');
                    return;
                }

                const testAchievement = achievements[0];
                log(`ğŸ“‹ æµ‹è¯•æˆæœ: ${testAchievement.title} (ID: ${testAchievement.id})`, 'info');

                // æŸ¥è¯¢æˆæœè¯¦æƒ…ï¼ˆæ¨¡æ‹Ÿ getAchievementWithUsersByIdï¼‰
                const { data: achievement, error: detailError } = await supabase
                    .from('achievements')
                    .select(`
                        *,
                        publisher:users!publisher_id (id, username, email, full_name),
                        instructor:users!instructor_id (id, username, email, full_name),
                        achievement_type:achievement_types (id, name)
                    `)
                    .eq('id', testAchievement.id)
                    .single();

                if (detailError || !achievement) {
                    log(`âŒ è·å–æˆæœè¯¦æƒ…å¤±è´¥: ${detailError?.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    return;
                }

                // è·å–åä½œè€…ä¿¡æ¯
                const { data: parentRelations, error: parentError } = await supabase
                    .from('achievements_parents')
                    .select(`
                        *,
                        parent:users!parent_id (id, username, email, full_name)
                    `)
                    .eq('achievement_id', achievement.id)
                    .order('id');

                if (parentError) {
                    log(`âŒ è·å–åä½œè€…å¤±è´¥: ${parentError.message}`, 'error');
                    return;
                }

                const parents = parentRelations?.map(item => item.parent).filter(Boolean) || [];
                achievement.parents = parents;

                log(`ğŸ‘¥ æˆæœæœ‰ ${parents.length} ä¸ªåä½œè€…`, 'info');

                if (parents.length > 0) {
                    parents.forEach((parent, index) => {
                        log(`   ğŸ‘¤ åä½œè€…${index + 1}: ${parent.full_name || parent.username} (${parent.email || 'æ— é‚®ç®±'}) - ID: ${parent.id}`, 'info');
                    });
                }

                // æ¸²æŸ“å•ä¸ªæˆæœ
                const resultsDiv = document.getElementById('results');
                const renderDiv = document.createElement('div');
                renderDiv.innerHTML = `
                    <h3>ğŸ“‹ å•ä¸ªæˆæœè¯¦æƒ…ï¼ˆå«åä½œè€…ï¼‰</h3>
                    ${renderAchievement(achievement)}
                `;
                resultsDiv.appendChild(renderDiv);

                log('âœ… å•ä¸ªæˆæœ+åä½œè€…æŸ¥è¯¢æµ‹è¯•æˆåŠŸï¼', 'success');

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            log('ğŸ§¹ ç»“æœå·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„æµ‹è¯•', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ å®¡æ‰¹é¡µé¢å¤šåä½œè€…æ˜¾ç¤ºæµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('ğŸ“ è¯·è¾“å…¥æ•™å¸ˆIDï¼Œç„¶åç‚¹å‡»æµ‹è¯•æŒ‰é’®', 'info');
            log('ğŸ’¡ æç¤ºï¼šå¯ä»¥ä»ç”¨æˆ·è¡¨ä¸­è·å–æ•™å¸ˆIDï¼ˆrole=2ï¼‰', 'info');
        });
    </script>
</body>
</html>