<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåä½œè€…åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>å¤šåä½œè€…åŠŸèƒ½æµ‹è¯• - achievements_parentsè¡¨</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æœ¬é¡µé¢ç”¨äºéªŒè¯ achievements_parents è¡¨çš„å¤šåä½œè€…æ’å…¥åŠŸèƒ½ã€‚</p>
        <p><strong>è¡¨ç»“æ„ï¼š</strong></p>
        <ul>
            <li>id (BIGSERIAL): è‡ªå¢ä¸»é”®ï¼Œä»1å¼€å§‹</li>
            <li>achievement_id (UUID): æˆæœIDï¼Œæ¥è‡ª achievements.id</li>
            <li>parent_id (UUID): åä½œè€…ç”¨æˆ·IDï¼Œæ¥è‡ª users.id</li>
            <li>created_at (TIMESTAMPTZ): è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•å‚æ•°</h3>
        <label for="achievementId">æˆæœID (achievement_id):</label><br>
        <input type="text" id="achievementId" placeholder="è¾“å…¥æˆæœUUID" size="40" value="test-achievement-uuid">
        <br><br>
        
        <label for="collaboratorIds">åä½œè€…IDåˆ—è¡¨ (parent_idï¼Œé€—å·åˆ†éš”):</label><br>
        <input type="text" id="collaboratorIds" placeholder="user-uuid-1,user-uuid-2,user-uuid-3" size="60" value="user-1,user-2,user-3">
        <br><br>
        
        <button onclick="testInsertCollaborators()">ğŸ§ª æµ‹è¯•æ’å…¥åä½œè€…</button>
        <button onclick="testQueryCollaborators()">ğŸ“‹ æŸ¥è¯¢åä½œè€…</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
    </div>

    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://vntvrdkjtfdcnvwgrubo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZudHZyZGtqdGZkY252d2dydWJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MTI5MjcsImV4cCI6MjA1MTM4ODkyN30.5xflIIFviYqA8Fh_T3mB_2qTm0_Hp3s2_BhZqW7zJ8g';

        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
            }

            from(table) {
                return new TableBuilder(this, table);
            }

            async request(method, url, options = {}) {
                const response = await fetch(`${this.url}/rest/v1${url}`, {
                    method,
                    headers: {
                        'apikey': this.key,
                        'Authorization': `Bearer ${this.key}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`HTTP ${response.status}: ${error.message || response.statusText}`);
                }

                const data = await response.json();
                return { data, error: null };
            }
        }

        class TableBuilder {
            constructor(client, table) {
                this.client = client;
                this.table = table;
                this.query = {
                    select: '*',
                    filter: [],
                    orderBy: null
                };
            }

            select(columns = '*') {
                this.query.select = columns;
                return this;
            }

            insert(data) {
                return this.client.request('POST', `/${this.table}`, {
                    body: JSON.stringify(data)
                });
            }

            eq(column, value) {
                this.query.filter.push(`${column}=eq.${value}`);
                return this;
            }

            order(column, options = {}) {
                const direction = options.ascending ? 'asc' : 'desc';
                this.query.orderBy = `${column}.${direction}`;
                return this;
            }

            async get() {
                let url = `/${this.table}?select=${this.query.select}`;
                
                if (this.query.filter.length > 0) {
                    url += '&' + this.query.filter.join('&');
                }
                
                if (this.query.orderBy) {
                    url += `&order=${this.query.orderBy}`;
                }

                return this.client.request('GET', url);
            }

            async single() {
                const result = await this.get();
                return {
                    data: result.data?.[0] || null,
                    error: result.error
                };
            }
        }

        const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testInsertCollaborators() {
            try {
                log('ğŸš€ å¼€å§‹æµ‹è¯•å¤šåä½œè€…æ’å…¥åŠŸèƒ½...', 'info');

                const achievementId = document.getElementById('achievementId').value.trim();
                const collaboratorsInput = document.getElementById('collaboratorIds').value.trim();

                if (!achievementId) {
                    log('âŒ è¯·è¾“å…¥æˆæœID', 'error');
                    return;
                }

                if (!collaboratorsInput) {
                    log('âŒ è¯·è¾“å…¥åä½œè€…IDåˆ—è¡¨', 'error');
                    return;
                }

                const collaboratorIds = collaboratorsInput.split(',').map(id => id.trim()).filter(id => id);

                if (collaboratorIds.length === 0) {
                    log('âŒ åä½œè€…IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                log(`ğŸ“‹ æˆæœID: ${achievementId}`, 'info');
                log(`ğŸ‘¥ åä½œè€…IDæ•°é‡: ${collaboratorIds.length}`, 'info');
                log(`ğŸ‘¥ åä½œè€…IDåˆ—è¡¨: [${collaboratorIds.join(', ')}]`, 'info');

                // å‡†å¤‡æ’å…¥æ•°æ® - æ¯ä¸ªåä½œè€…åˆ›å»ºä¸€è¡Œè®°å½•
                const insertData = collaboratorIds.map(parentId => ({
                    achievement_id: achievementId,
                    parent_id: parentId
                }));

                log(`ğŸ“ å‡†å¤‡æ’å…¥ ${insertData.length} æ¡è®°å½•åˆ° achievements_parents è¡¨...`, 'info');

                insertData.forEach((item, index) => {
                    log(`   è®°å½•${index + 1}: achievement_id=${item.achievement_id}, parent_id=${item.parent_id}`, 'info');
                });

                // æ‰§è¡Œæ’å…¥
                const { data, error } = await supabase
                    .from('achievements_parents')
                    .insert(insertData)
                    .select('*')
                    .order('id');

                if (error) {
                    log(`âŒ æ’å…¥å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                log(`âœ… æˆåŠŸæ’å…¥ ${data.length} æ¡è®°å½•ï¼`, 'success');

                // æ˜¾ç¤ºæ’å…¥çš„ç»“æœ
                data.forEach((record, index) => {
                    log(`   âœ… è®°å½•${index + 1}: id=${record.id}, achievement_id=${record.achievement_id}, parent_id=${record.parent_id}, created_at=${record.created_at}`, 'success');
                });

                // éªŒè¯IDæ˜¯å¦ä»1å¼€å§‹è‡ªåŠ¨é€’å¢
                if (data.length > 0) {
                    const firstId = data[0].id;
                    log(`ğŸ¯ achievements_parents è¡¨çš„IDä» ${firstId} å¼€å§‹`, 'success');
                    
                    if (data.length > 1) {
                        const lastId = data[data.length - 1].id;
                        log(`ğŸ“Š æ’å…¥çš„è®°å½•IDèŒƒå›´: ${firstId} - ${lastId}`, 'success');
                    }
                }

                log('ğŸ‰ å¤šåä½œè€…æ’å…¥åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testQueryCollaborators() {
            try {
                log('ğŸ” å¼€å§‹æŸ¥è¯¢åä½œè€…æ•°æ®...', 'info');

                const achievementId = document.getElementById('achievementId').value.trim();

                if (!achievementId) {
                    log('âŒ è¯·è¾“å…¥æˆæœID', 'error');
                    return;
                }

                // æŸ¥è¯¢æŒ‡å®šæˆæœçš„æ‰€æœ‰åä½œè€…
                const { data, error } = await supabase
                    .from('achievements_parents')
                    .select(`
                        *,
                        parent:users!parent_id (id, username, email, full_name)
                    `)
                    .eq('achievement_id', achievementId)
                    .order('id');

                if (error) {
                    log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                if (!data || data.length === 0) {
                    log(`ğŸ“‹ æˆæœ ${achievementId} æ²¡æœ‰æ‰¾åˆ°åä½œè€…`, 'info');
                    return;
                }

                log(`ğŸ“‹ æ‰¾åˆ° ${data.length} ä¸ªåä½œè€…ï¼š`, 'info');

                data.forEach((record, index) => {
                    const parent = record.parent;
                    log(`   ğŸ‘¤ åä½œè€…${index + 1}: ${parent?.full_name || parent?.username || 'æœªçŸ¥'} (${parent?.email || 'æ— é‚®ç®±'}) - ID: ${record.parent_id}`, 'info');
                });

                log('ğŸ‰ åä½œè€…æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');

            } catch (error) {
                log(`âŒ æŸ¥è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            log('ğŸ§¹ ç»“æœå·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„æµ‹è¯•', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ å¤šåä½œè€…åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('ğŸ“ è¯·è¾“å…¥æµ‹è¯•å‚æ•°ï¼Œç„¶åç‚¹å‡»æµ‹è¯•æŒ‰é’®', 'info');
        });
    </script>
</body>
</html>