<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæœæŸ¥çœ‹é¡µé¢åä½œè€…æ˜¾ç¤ºæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">æˆæœæŸ¥çœ‹é¡µé¢åä½œè€…æ˜¾ç¤ºæµ‹è¯•</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">æµ‹è¯•åŠŸèƒ½</h2>
            <div class="space-y-4">
                <div class="flex items-center space-x-4">
                    <button onclick="testGetAchievementsByRole()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        æµ‹è¯• getAchievementsByRole
                    </button>
                    <span class="text-sm text-gray-600">æµ‹è¯•æ•™å¸ˆè·å–æˆæœåˆ—è¡¨æ—¶æ˜¯å¦åŒ…å«åä½œè€…ä¿¡æ¯</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="testGetAchievementWithUsersById()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                        æµ‹è¯• getAchievementWithUsersById
                    </button>
                    <span class="text-sm text-gray-600">æµ‹è¯•è·å–å•ä¸ªæˆæœè¯¦æƒ…æ—¶æ˜¯å¦åŒ…å«åä½œè€…ä¿¡æ¯</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="testGetAchievementParents()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                        æµ‹è¯• getAchievementParents
                    </button>
                    <span class="text-sm text-gray-600">æµ‹è¯•ç›´æ¥è·å–åä½œè€…ä¿¡æ¯</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="clearResults()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        æ¸…ç©ºç»“æœ
                    </button>
                    <span class="text-sm text-gray-600">æ¸…ç©ºæµ‹è¯•ç»“æœ</span>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœåŒºåŸŸ -->
        <div id="testResults" class="space-y-4">
            <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://your-project-id.supabase.co';
        const supabaseKey = 'your-anon-key';
        
        // æ¨¡æ‹Ÿ AchievementService ç±»
        class AchievementService {
            static async getAchievementsByRole(userRole) {
                console.log(`ğŸ“Š æµ‹è¯• getAchievementsByRoleï¼Œè§’è‰²: ${userRole}`);
                
                try {
                    // æ¨¡æ‹Ÿæ•™å¸ˆè·å–æ‰€æœ‰å­¦ç”Ÿçš„æˆæœ
                    if (userRole === 2) {
                        // 1. å…ˆè·å–å­¦ç”ŸID
                        const { data: students } = await supabase
                            .from('users')
                            .select('id')
                            .eq('role', 1);
                        
                        const studentIds = students?.map(s => s.id) || [];
                        
                        if (studentIds.length === 0) {
                            return { success: true, data: [] };
                        }
                        
                        // 2. è·å–æˆæœ
                        const { data, error } = await supabase
                            .from('achievements')
                            .select(`
                                *,
                                achievement_types (name),
                                publisher:users!publisher_id (username, email, full_name),
                                instructor:users!instructor_id (username, email, full_name)
                            `)
                            .in('publisher_id', studentIds)
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        
                        // 3. ä¸ºæ¯ä¸ªæˆæœè·å–åä½œè€…ä¿¡æ¯
                        const achievementsWithParents = await Promise.all(
                            data.map(async (achievement) => {
                                try {
                                    const parentResult = await this.getAchievementParents(achievement.id);
                                    if (parentResult.success && parentResult.data) {
                                        const parents = parentResult.data.map(item => item.parent).filter(Boolean);
                                        achievement.parents = parents;
                                    }
                                } catch (error) {
                                    console.warn(`è·å–æˆæœ ${achievement.id} çš„åä½œè€…ä¿¡æ¯å¤±è´¥:`, error);
                                    achievement.parents = [];
                                }
                                return achievement;
                            })
                        );
                        
                        return { success: true, data: achievementsWithParents };
                    }
                    
                    return { success: true, data: [] };
                } catch (error) {
                    console.error('Error in getAchievementsByRole:', error);
                    return { success: false, message: error.message };
                }
            }
            
            static async getAchievementWithUsersById(achievementId) {
                console.log(`ğŸ“Š æµ‹è¯• getAchievementWithUsersByIdï¼ŒæˆæœID: ${achievementId}`);
                
                try {
                    // è·å–æˆæœåŸºæœ¬ä¿¡æ¯
                    const { data, error } = await supabase
                        .from('achievements')
                        .select(`
                            *,
                            achievement_types (name),
                            publisher:users!publisher_id (id, username, email, full_name),
                            instructor:users!instructor_id (id, username, email, full_name)
                        `)
                        .eq('id', achievementId)
                        .single();
                    
                    if (error) throw error;
                    
                    // è·å–åä½œè€…ä¿¡æ¯
                    const parentResult = await this.getAchievementParents(achievementId);
                    if (parentResult.success && parentResult.data) {
                        const parents = parentResult.data.map(item => item.parent).filter(Boolean);
                        data.parents = parents;
                    }
                    
                    return { success: true, data };
                } catch (error) {
                    console.error('Error in getAchievementWithUsersById:', error);
                    return { success: false, message: error.message };
                }
            }
            
            static async getAchievementParents(achievementId) {
                console.log(`ğŸ“Š æµ‹è¯• getAchievementParentsï¼ŒæˆæœID: ${achievementId}`);
                
                try {
                    const { data, error } = await supabase
                        .from('achievements_parents')
                        .select(`
                            *,
                            parent:users!parent_id (id, username, email, full_name)
                        `)
                        .eq('achievement_id', achievementId)
                        .order('created_at');

                    if (error) throw error;

                    return { success: true, data };
                } catch (error) {
                    console.error('Error in getAchievementParents:', error);
                    return { success: false, message: error.message };
                }
            }
        }

        // æµ‹è¯•å‡½æ•°
        async function testGetAchievementsByRole() {
            logResult('å¼€å§‹æµ‹è¯• getAchievementsByRole (æ•™å¸ˆè§’è‰²)...', 'info');
            
            try {
                const result = await AchievementService.getAchievementsByRole(2);
                
                if (result.success) {
                    const achievements = result.data || [];
                    logResult(`âœ… æˆåŠŸè·å– ${achievements.length} æ¡æˆæœè®°å½•`, 'success');
                    
                    // æ˜¾ç¤ºå‰3æ¡æˆæœçš„åä½œè€…ä¿¡æ¯
                    achievements.slice(0, 3).forEach((achievement, index) => {
                        const parents = achievement.parents || [];
                        logResult(`ğŸ“‹ æˆæœ ${index + 1}: "${achievement.title}" - åä½œè€…æ•°é‡: ${parents.length}`, 'info');
                        
                        if (parents.length > 0) {
                            parents.forEach(parent => {
                                logResult(`  ğŸ‘¤ åä½œè€…: ${parent.full_name || parent.username} (${parent.email})`, 'success');
                            });
                        } else {
                            logResult(`  â„¹ï¸  è¯¥æˆæœæ— åä½œè€…`, 'info');
                        }
                    });
                } else {
                    logResult(`âŒ è·å–å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                logResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetAchievementWithUsersById() {
            // å…ˆè·å–ä¸€ä¸ªæˆæœIDç”¨äºæµ‹è¯•
            try {
                const { data: achievements } = await supabase
                    .from('achievements')
                    .select('id, title')
                    .limit(1);
                
                if (!achievements || achievements.length === 0) {
                    logResult('âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨äºæµ‹è¯•çš„æˆæœ', 'error');
                    return;
                }
                
                const achievementId = achievements[0].id;
                const achievementTitle = achievements[0].title;
                
                logResult(`å¼€å§‹æµ‹è¯• getAchievementWithUsersByIdï¼Œæµ‹è¯•æˆæœ: "${achievementTitle}"...`, 'info');
                
                const result = await AchievementService.getAchievementWithUsersById(achievementId);
                
                if (result.success) {
                    const achievement = result.data;
                    const parents = achievement.parents || [];
                    
                    logResult(`âœ… æˆåŠŸè·å–æˆæœè¯¦æƒ…: "${achievement.title}"`, 'success');
                    logResult(`ğŸ‘¤ å‘å¸ƒè€…: ${achievement.publisher?.full_name || achievement.publisher?.username}`, 'info');
                    logResult(`ğŸ‘¨â€ğŸ« æŒ‡å¯¼è€å¸ˆ: ${achievement.instructor?.full_name || achievement.instructor?.username || 'æœªæŒ‡å®š'}`, 'info');
                    logResult(`ğŸ¤ åä½œè€…æ•°é‡: ${parents.length}`, 'info');
                    
                    if (parents.length > 0) {
                        parents.forEach(parent => {
                            logResult(`  ğŸ‘¥ åä½œè€…: ${parent.full_name || parent.username} (${parent.email})`, 'success');
                        });
                    } else {
                        logResult(`  â„¹ï¸  è¯¥æˆæœæ— åä½œè€…`, 'info');
                    }
                } else {
                    logResult(`âŒ è·å–å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                logResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetAchievementParents() {
            // å…ˆè·å–ä¸€ä¸ªæˆæœIDç”¨äºæµ‹è¯•
            try {
                const { data: achievements } = await supabase
                    .from('achievements')
                    .select('id, title')
                    .limit(1);
                
                if (!achievements || achievements.length === 0) {
                    logResult('âŒ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨äºæµ‹è¯•çš„æˆæœ', 'error');
                    return;
                }
                
                const achievementId = achievements[0].id;
                const achievementTitle = achievements[0].title;
                
                logResult(`å¼€å§‹æµ‹è¯• getAchievementParentsï¼Œæµ‹è¯•æˆæœ: "${achievementTitle}"...`, 'info');
                
                const result = await AchievementService.getAchievementParents(achievementId);
                
                if (result.success) {
                    const parents = result.data || [];
                    logResult(`âœ… æˆåŠŸè·å–åä½œè€…ä¿¡æ¯ï¼Œæ•°é‡: ${parents.length}`, 'success');
                    
                    if (parents.length > 0) {
                        parents.forEach(parent => {
                            logResult(`  ğŸ‘¥ åä½œè€…: ${parent.parent?.full_name || parent.parent?.username} (${parent.parent?.email})`, 'success');
                        });
                    } else {
                        logResult(`  â„¹ï¸  è¯¥æˆæœæ— åä½œè€…`, 'info');
                    }
                } else {
                    logResult(`âŒ è·å–å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                logResult(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            
            const colorClass = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600'
            }[type] || 'text-gray-600';
            
            const bgClass = {
                'info': 'bg-blue-50 border-blue-200',
                'success': 'bg-green-50 border-green-200',
                'error': 'bg-red-50 border-red-200',
                'warning': 'bg-yellow-50 border-yellow-200'
            }[type] || 'bg-gray-50 border-gray-200';
            
            const resultHtml = `
                <div class="border rounded-lg p-4 ${bgClass}">
                    <div class="flex items-start space-x-2">
                        <span class="text-xs text-gray-500 whitespace-nowrap">${timestamp}</span>
                        <span class="${colorClass} break-words">${message}</span>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            logResult('æµ‹è¯•ç»“æœå·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logResult('ğŸš€ æˆæœæŸ¥çœ‹é¡µé¢åä½œè€…æ˜¾ç¤ºæµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            logResult('ğŸ“ è¯·é…ç½® Supabase è¿æ¥ä¿¡æ¯åå¼€å§‹æµ‹è¯•', 'warning');
            logResult('ğŸ”§ åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯', 'info');
        });
    </script>
</body>
</html>